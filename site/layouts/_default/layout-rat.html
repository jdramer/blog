<!DOCTYPE html>
<html lang="{{ .Lang }}">
<head>
    {{ partial "head.html" . }}
</head>
<body>

<div class="container">
  <h1 class="title is-1">I saw another rat 🐀!</h1>

  <form>
    <div class="field">
      <label class="label">Notes</label>
      <div class="control">
        <textarea class="textarea" style="background-color: #333333" name="notes"></textarea>
      </div>
    </div>

    <div class="field is-grouped">
      <div class="control">
        <button id="submit" style="visibility: hidden" class="button is-primary">Submit</button>
      </div>
    </div>


    <div id="message-info" class="has-text-light"></div>
    <div id="message-success" class="has-text-success"></div>
    <div id="message-error" class="has-text-warning"></div>
  </form>

</div>
<!--
  Webpack HMR runtime (https://github.com/webpack/webpack-dev-server/issues/2792)

  Fix so that common code among all the js libraries is shared in a single file
  before all of them start.
-->
{{ partial "scripts/webpack-runtime.html" . }}
<script>
const ClientID = '318649152292-04hpht7f9kbk273jsnke9enr765stfqh.apps.googleusercontent.com'
const APIKey = 'AIzaSyBRA-FftPYsyvmRpnbq2_ZdtCHlxDvVzaw'
const DiscoveryDocs = 'https://sheets.googleapis.com/$discovery/rest?version=v4'
const Scopes = 'https://www.googleapis.com/auth/spreadsheets'

let gapiInited, gisInited, tokenClient

function gapiLoaded() {
  gapi.load('client', initializeGapiClient);
}

/**
  * Callback after the API client is loaded. Loads the
  * discovery doc to initialize the API.
  */
async function initializeGapiClient() {
  await gapi.client.init({
    apiKey: APIKey,
    discoveryDocs: [DiscoveryDocs],
  })
  gapiInited = true
  maybeEnableSubmitButton()
}

function gisLoaded() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: ClientID,
    scope: Scopes,
  })
  gisInited = true
  maybeEnableSubmitButton()
}

function maybeEnableSubmitButton() {
  if (gapiInited && gisInited) {
    document.getElementById('submit').style.visibility = 'visible';
  }
}

function handleAuthClickAndSubmitRat() {
  tokenClient.callback = async (resp) => {
    if (resp.error !== undefined) {
      throw (resp)
    }

    // We have all the permissions needed to continue!
    await submitRatEntry()
  }
  if (gapi.client.getToken() === null) {
    // Prompt the user to select a Google Account and ask for consent to share their data
    // when establishing a new session.
    tokenClient.requestAccessToken({prompt: 'consent'});
  } else {
    // Skip display of account chooser and consent dialog for an existing session.
    tokenClient.requestAccessToken({prompt: ''});
  }
}

function appendMessage(level, message) {
  const messageRoot = document.querySelector(`#message-${level}`)

  const newEl = document.createElement('div')
  newEl.innerText = message
  messageRoot.appendChild(newEl)
}

async function submitRatEntry() {
  appendMessage('info', `Start`)
  const formData = new FormData(document.querySelector('form'))
  const formProps = Object.fromEntries(formData)
  const location = await new Promise((resolve, reject) => {
    appendMessage('info', 'Doing reverse geoloc')
    navigator.geolocation.getCurrentPosition(async function(position) {
      const pos = {
        lat: position.coords.latitude,
        lon: position.coords.longitude,
      }

      /*
        Response shape:
        {
          address: Object,
          display_name: string,
          lat: number,
          lon: number
        }
       */
      const address = fetch(`https://geocode.maps.co/reverse?lat=${pos.lat}&lon=${pos.lon}`).then(r => r.json())
      appendMessage('info', 'Reverse geoloc complete')
      resolve(address)
    }, reject)
  })

  const date = (new Date()).toLocaleString()
  let values = [
    // date, lat, lon, address, notes
    [date, location.lat, location.lon, location.display_name, formProps.notes],
  ]
  appendMessage('info', `Sending values ${JSON.stringify(values)}`)
  const body = { values: values, }
  try {
    const response = await gapi.client.sheets.spreadsheets.values.append({
      spreadsheetId: '1GbViHaRonUR-sSYtBXbkDrOUEdmoivUwCVCJtT8G7aY',
      range: 'Sheet1',
      valueInputOption: 'USER_ENTERED',
      resource: body,
    })
    const result = response.result;
    console.log(`${result.updates.updatedCells} cells appended.`);
    appendMessage('success', `Values submitted successfully, go catch new rats!`)
  } catch (err) {
    appendMessage('error', `Failed to submit values: ${err.message}`)
    return;
  }
}

function main() {
  document.querySelector('form').addEventListener("submit", (e) => {
    e.preventDefault()
    handleAuthClickAndSubmitRat()
  })
}

main()

</script>

<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

</body>
</html>
